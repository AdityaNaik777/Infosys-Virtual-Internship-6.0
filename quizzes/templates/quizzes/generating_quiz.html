{% extends "quizzes/base_quiz.html" %}
{% block title %}Generating Quiz — {{ subcategory.name }}{% endblock %}

{% block quiz_content %}
  <h2 class="q-text">Preparing your AI-generated quiz…</h2>
  <p class="muted">Topic: <strong>{{ subcategory.name }}</strong> · Difficulty: <strong>{{ difficulty }}</strong></p>

  <div style="margin-top:20px">
    <div class="progress" aria-hidden="true" style="height:18px;">
      <span id="gen-progress" style="width:6%; height:100%; display:block; background:linear-gradient(90deg,var(--accent-2),var(--accent)); border-radius:999px;"></span>
    </div>
    <p id="gen-status" style="margin-top:10px" class="muted">Requesting AI...</p>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const attemptId = "{{ quiz_attempt.id }}";
  const url = "{% url 'quizzes:generate_questions' attempt_id=quiz_attempt.id %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++){
        const c = cookies[i].trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length+1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function pollGeneration() {
    try {
      // POST to trigger generation
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({})
      });

      const data = await resp.json();

      if (resp.ok && data.success) {
        // Redirect to first question page
        window.location.href = data.redirect_url;
        return;
      }

      // show error message
      document.getElementById('gen-status').innerText = "Generation failed: " + (data.error || resp.statusText);
    } catch (err) {
      document.getElementById('gen-status').innerText = "Network error: " + err;
    }
  }

  // Animate the small progress bar while waiting
  let prog = 6;
  const bar = document.getElementById('gen-progress');
  const ticker = setInterval(()=>{
    prog = Math.min(92, prog + Math.random()*6);
    if(bar) bar.style.width = prog + '%';
  }, 420);

  window.addEventListener('DOMContentLoaded', async ()=>{
    await pollGeneration();
    clearInterval(ticker);
    if(bar) bar.style.width = '100%';
  });
})();
</script>
{% endblock %}
